# frozen_string_literal: true

class VulnerabilityDecorator < SimpleDelegator
  def self.wrap(collection)
    collection.map do |obj|
      new obj
    end
  end

  def show_link_nvd_codename
    "https://nvd.nist.gov/vuln/search/results?form_type=Basic&results_type=overview&query=#{codename}&search_type=all"
  end

  def show_feed
    Vulnerability.human_enum_name(:feeds, feed)
  end

  def show_state
    Vulnerability.human_enum_name(:states, state)
  end

  def show_blocked
    if blocked
      I18n.t('activerecord.attributes.vulnerability.created.automatic')
    else
      I18n.t('activerecord.attributes.vulnerability.created.manual')
    end
  end

  def show_actuality
    Vulnerability.human_enum_name(:actuality, actuality)
  end

  def show_relevance
    Vulnerability.human_enum_name(:relevance,relevance)
  end

  def show_custom_actuality
    Vulnerability.human_enum_name(:custom_actuality, custom_actuality)
  end

  def show_custom_relevance
    Vulnerability.human_enum_name(:custom_relevance, custom_relevance)
  end

  def show_vendors
    vendors.join(', ')
  end

  def show_products
    products.join(', ')
  end

  def show_cwe
    cwe.join(', ')
  end

  def show_cpe_array
    cpe
  end

  def show_cvss
    return "#{cvss3} (v3)" if cvss3.present?
    return "#{cvss2} (v2)" if cvss2.present?
    ''
  end

  def show_cvss_vector
    return "#{cvss3_vector} (v3)" if cvss3_vector.present?
    return "#{cvss2_vector} (v2)" if cvss2_vector.present?
    ''
  end

  def show_exploitability
    return "#{cvss3_exploitability} (v3)" if cvss3_exploitability.present?
    return "#{cvss2_exploitability} (v2)" if cvss2_exploitability.present?
    ''
  end

  def show_impact
    return "#{cvss3_impact} (v3)" if cvss3_impact.present?
    return "#{cvss2_impact} (v2)" if cvss2_impact.present?
    ''
  end

  def show_versions_array
    vendors_arr = versions || []
    result = []
    vendors_arr.each do |vendor_hash|
      products_arr = vendor_hash.dig('product', 'product_data') || []
      products_arr.each do |product_hash|
        versions_arr = product_hash.dig('version', 'version_data') || []
        versions_arr.each do |version_hash|
          hash = {
            vendor: vendor_hash.fetch('vendor_name', ''),
            product: product_hash.fetch('product_name', ''),
            version: version_hash.fetch('version_value', ''),
            affected: version_hash.fetch('version_affected', '')
          }
          result << hash
        end
      end
    end
    result
  end

  def show_versions_string
    return '' if versions == '{}'
    vendors_arr = versions || []
    result = []
    vendors_arr.each do |vendor_hash|
      products_arr = vendor_hash.dig('product', 'product_data') || []
      products_arr.each do |product_hash|
        versions_arr = product_hash.dig('version', 'version_data') || []
        versions_arr.each do |version_hash|
        string =  <<-TEXT
          #{vendor_hash.fetch('vendor_name', '')}
          #{product_hash.fetch('product_name', '')}
          (#{version_hash.fetch('version_affected', '')}
          #{version_hash.fetch('version_value', '')})
        TEXT
          result << string
        end
      end
    end
    result.join(', ')
  end

  def show_description
    description.join('. ')
  end

  def show_references
    references.join(', ')
  end

  private

  def yes_or_no(value)
    value ? I18n.t('labels.yes_label') : I18n.t('labels.no_label')
  end
end
